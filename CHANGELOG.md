# Changelog

Todas as mudan√ßas not√°veis neste projeto ser√£o documentadas neste arquivo.

## [1.5.0] - 2025-01-25
### Added
- **NOVA INTERFACE**: Sistema de aprova√ß√µes com menus separados
- **Aprova√ß√µes R√°pidas**: Lista tradicional de pend√™ncias
- **Aprova√ß√µes Semanais**: Interface com navega√ß√£o por semana
- **Cancelar Aprova√ß√£o**: Reverter aprova√ß√µes j√° processadas
- **Notifica√ß√µes**: Sistema integrado do Perfex para avisos
- Visualiza√ß√£o de todos os status: Pendente, Aprovado, Rejeitado

### Enhanced
- Interface mais intuitiva para gerentes
- Navega√ß√£o semanal com filtros visuais
- Hist√≥rico completo das decis√µes tomadas
- Remo√ß√£o autom√°tica de timers ao cancelar aprova√ß√£o
- Sincroniza√ß√£o autom√°tica entre as telas

### Technical
- Novos m√©todos: `manage_weekly()`, `cancel_approval()`
- Model: `get_weekly_approvals()`, `cancel_approval()`, `remove_approved_timers()`
- View: `manage_weekly.php` para interface semanal
- JavaScript: `manage_weekly.js` com funcionalidades espec√≠ficas

## [1.4.0] - 2025-01-25
### Changed
- **ARQUITETURA**: M√≥dulo agora opera em modo **UNIDIRECIONAL**
- Timesheet ‚Üí Quadro de horas (apenas nesta dire√ß√£o)
- Quadro de horas √© apenas para visualiza√ß√£o
- Removido processamento de rec√°lculos pendentes
- Removidas fun√ß√µes de sincroniza√ß√£o bidirecional

### Fixed
- Campo `perfex_timer_id` criado automaticamente se n√£o existir
- Valida√ß√£o mais robusta para submiss√£o de timesheets
- Logs mais detalhados para debug e monitoramento

### Removed
- Sincroniza√ß√£o Quadro ‚Üí Timesheet (modo bidirecional)
- Processamento autom√°tico de altera√ß√µes no quadro
- Endpoint de sincroniza√ß√£o AJAX
</original>

## [1.3.18] - 2025-01-26

### Fixed
- **CR√çTICO**: Corrigido hook de exclus√£o que causava tela branca ap√≥s deletar timers
- Hook `task_timer_deleted` agora usa tratamento robusto de erros
- Exclus√£o de timers n√£o interfere mais na navega√ß√£o do usu√°rio
- Implementado sistema de rec√°lculo inteligente e n√£o-bloqueante

### Changed
- Hook de exclus√£o simplificado para evitar opera√ß√µes pesadas durante exclus√£o
- Rec√°lculos movidos para momento apropriado (visualiza√ß√£o do timesheet)
- Melhor tratamento de erros com fallback de emerg√™ncia
- Sistema de marca√ß√£o para rec√°lculos pendentes

### Technical
- Fun√ß√£o `process_pending_recalculations()` para processar em background
- Try/catch robusto no hook de exclus√£o
- Limpeza de refer√™ncias sem bloquear fluxo principal

## [1.3.17] - 2025-01-26

### Fixed
- Corre√ß√£o no auto-save para evitar perda de dados em campos editados rapidamente
- Implementa√ß√£o de debounce de 2 segundos no salvamento autom√°tico
- Melhorias na valida√ß√£o de entradas antes do salvamento

### Changed
- Auto-save agora aguarda 2 segundos ap√≥s √∫ltima edi√ß√£o antes de salvar
- Melhor feedback visual durante o processo de salvamento
- Valida√ß√£o mais rigorosa de dados antes do envio ao servidor

## [1.3.16] - 2025-01-26

### üöÄ SINCRONIZA√á√ÉO BIDIRECIONAL COMPLETA
- **V√≠nculo estabelecido**: Campo `perfex_timer_id` adicionado para referenciar timers do Perfex
- **Hooks completos**: Monitoramento de todos os eventos de timer (criar, editar, deletar, parar)
- **Sincroniza√ß√£o autom√°tica**: Altera√ß√µes no quadro de horas refletem instantaneamente no timesheet
- **Rec√°lculo inteligente**: Horas s√£o recalculadas baseadas nos timers reais do Perfex

### üîß IMPLEMENTA√á√ïES T√âCNICAS
- **Migration 1316**: Adiciona campo `perfex_timer_id` com √≠ndice para performance
- **Fun√ß√£o sync_from_perfex_timer()**: Processa altera√ß√µes vindas do Perfex CRM  
- **Fun√ß√£o recalculate_task_hours()**: Recalcula horas baseado em timers ativos
- **Hooks m√∫ltiplos**: `task_timer_started`, `task_timer_stopped`, `task_timer_deleted`, `after_timer_update`

### üìã FUNCIONALIDADES
- **Timesheet ‚Üí Perfex**: Na aprova√ß√£o, salva `timer_id` na entrada do timesheet
- **Perfex ‚Üí Timesheet**: Qualquer altera√ß√£o no timer atualiza o timesheet automaticamente
- **Logs detalhados**: Rastreamento completo de todas as sincroniza√ß√µes
- **Preven√ß√£o de loops**: Evita sincroniza√ß√µes circulares

### üéØ CASOS DE USO RESOLVIDOS
- ‚úÖ Gestor altera horas no quadro de tempo ‚Üí Timesheet atualiza automaticamente
- ‚úÖ Timer √© deletado no Perfex ‚Üí Refer√™ncia √© removida do timesheet
- ‚úÖ Timer √© editado no Perfex ‚Üí Horas s√£o recalculadas no timesheet
- ‚úÖ Funcion√°rio para timer ‚Üí Timesheet reflete as horas trabalhadas

## [1.3.15] - 2025-08-26

### üîß ALTERA√á√ïES
- Corre√ß√£o de erro 500 na aprova√ß√£o - melhor tratamento de exce√ß√µes e valida√ß√µes


## [1.3.14] - 2025-08-26

### üîß ALTERA√á√ïES
- Corre√ß√£o cr√≠tica: sincroniza√ß√£o criar uma entrada por dia na tbltaskstimers


## [1.3.13] - 2025-08-26

### üîß ALTERA√á√ïES
- Corre√ß√£o cr√≠tica: helper path e migration class


## [1.3.12] - 2025-08-25

### üîß ALTERA√á√ïES
- Corre√ß√£o cr√≠tica: caminho do helper para ativa√ß√£o do m√≥dulo


## [1.3.11] - 2025-08-25

### üîß ALTERA√á√ïES
- Novo build para download


## [1.3.10] - 2025-08-25

### üîß ALTERA√á√ïES
- Novo build para download


## [1.3.9] - 2025-08-25

### üîß ALTERA√á√ïES
- Corre√ß√£o da gera√ß√£o do ZIP com debug detalhado


## [1.3.8] - 2025-08-25

### üîß ALTERA√á√ïES
- Corre√ß√£o do carregamento do helper - file not found


## [1.3.7] - 2025-08-25

### üîß ALTERA√á√ïES
- Corre√ß√£o do carregamento do helper do m√≥dulo


## [1.3.6] - 2025-08-25

### üîß ALTERA√á√ïES
- Corre√ß√£o do carregamento do helper do m√≥dulo


## [1.3.5] - 2025-08-25

### üîß ALTERA√á√ïES
- Corre√ß√£o do carregamento do helper do m√≥dulo


## [1.3.4] - 2025-08-25

### üîß ALTERA√á√ïES
- Atualiza√ß√µes e melhorias gerais


## [1.3.3] - 2025-08-25

### üîß ALTERA√á√ïES
- Atualiza√ß√µes e melhorias gerais


## [1.3.2] - 2025-01-17

### üö® CORRE√á√ÉO CR√çTICA - SINCRONIZA√á√ÉO DE HORAS
- **Problema resolvido**: Quadro de tempo do Perfex agora recebe TODAS as horas da semana aprovada
- **Bug corrigido**: Anteriormente apenas um dia era sincronizado, agora todos os dias com horas s√£o processados
- **Melhoria na detec√ß√£o**: Verifica√ß√£o de timers existentes para evitar duplica√ß√£o
- **Logs detalhados**: Rastreamento completo do processo de sincroniza√ß√£o

### üîß MELHORIAS T√âCNICAS
- Fun√ß√£o `log_approved_hours_to_tasks` completamente reescrita
- C√°lculo correto das datas de cada dia da semana
- Inser√ß√£o direta na tabela `taskstimers` para melhor controle
- Adicionada coluna `perfex_timer_id` para rastrear refer√™ncias
- Logs mais detalhados para debugging

### ‚ö° FUNCIONALIDADES MELHORADAS
- Sincroniza√ß√£o bidirecional mais robusta
- Preven√ß√£o de duplica√ß√£o de timers
- Hor√°rios padr√£o configurados (9:00 AM como in√≠cio)
- Notas descritivas nos timers criados

### üéØ VALIDA√á√ïES ADICIONAIS
- Apenas entradas com horas > 0 s√£o processadas
- Verifica√ß√£o de task_id v√°lido antes da cria√ß√£o
- Tratamento de erros melhorado


## [1.3.1] - 2025-08-25

### üîß ALTERA√á√ïES
- Sistema de build automatizado implementado


## [1.3.0] - 2025-01-24

### üöÄ SISTEMA DE BUILD AUTOMATIZADO
- **Script de build**: Sistema completo de versionamento autom√°tico
- **Gera√ß√£o de ZIP**: Cria√ß√£o autom√°tica de releases com estrutura correta
- **Controle de vers√£o**: Incremento autom√°tico de vers√µes (major/minor/patch)
- **Migration autom√°tica**: Cria√ß√£o autom√°tica de arquivos de migra√ß√£o

### üîß FERRAMENTAS DE DESENVOLVIMENTO
- **build.php**: Script PHP para automatizar todo o processo de release
- **release.sh**: Script shell para facilitar o uso via linha de comando
- **README.md**: Documenta√ß√£o completa com instru√ß√µes de instala√ß√£o e uso
- **Versionamento sem√¢ntico**: Seguindo padr√£o MAJOR.MINOR.PATCH

### üìã FUNCIONALIDADES DO BUILD SYSTEM
- Atualiza√ß√£o autom√°tica de vers√£o em todos os arquivos
- Gera√ß√£o autom√°tica de changelog com timestamp
- Cria√ß√£o de ZIP com estrutura `/timesheet/` correta
- Logs detalhados do processo de build
- Suporte a diferentes tipos de vers√£o (patch, minor, major)

### üéØ MELHORIAS DE DOCUMENTA√á√ÉO
- Instru√ß√µes completas de instala√ß√£o
- Guia de desenvolvimento e contribui√ß√£o
- Documenta√ß√£o de troubleshooting
- Links para documenta√ß√£o oficial do Perfex CRM

### üîÑ USO DO SISTEMA
```bash
# Exemplo de uso
php build.php patch "Corre√ß√£o cr√≠tica de bug"
./release.sh minor "Nova funcionalidade de relat√≥rios"
```

## [1.2.0] - 2025-08-24

### üéØ SINCRONIZA√á√ÉO BIDIRECIONAL DEFINITIVA
- **Campo de refer√™ncia**: Adicionado campo `perfex_timer_id` na tabela `timesheet_entries`
- **Hooks corretos**: Usando apenas hooks que realmente existem no Perfex CRM
- **Refer√™ncia salva**: Timer criado na aprova√ß√£o agora salva refer√™ncia no timesheet
- **Sincroniza√ß√£o real**: Altera√ß√µes no quadro de horas agora refletem no timesheet

### üîß IMPLEMENTA√á√ïES T√âCNICAS
- **Hook task_timer_started**: Monitora quando timer √© iniciado
- **Hook task_timer_deleted**: Remove refer√™ncia quando timer √© deletado
- **Campo perfex_timer_id**: Armazena ID do timer do Perfex CRM
- **Logs detalhados**: Rastreamento completo da sincroniza√ß√£o

### üìã ESTRUTURA DE DADOS
```sql
ALTER TABLE timesheet_entries ADD COLUMN perfex_timer_id INT(11) NULL;
```

### üéØ FUNCIONALIDADES CORRIGIDAS
- Timesheet ‚Üí Quadro de Horas: Salva refer√™ncia na aprova√ß√£o
- Quadro de Horas ‚Üí Timesheet: Remove refer√™ncia na exclus√£o
- Logs detalhados para debugging em tempo real
- Hooks baseados na documenta√ß√£o oficial do Perfex CRM

### üöÄ TESTE EM TEMPO REAL
- Logs vis√≠veis no Log de Atividades do Perfex
- Rastreamento de cada opera√ß√£o de sincroniza√ß√£o
- Identifica√ß√£o de problemas em tempo real

## [1.1.1] - 2025-08-24

### üö® CORRE√á√ïES CR√çTICAS
- **Erro de aprova√ß√£o/rejei√ß√£o**: Corrigido erro "manage_data is not defined" na tela de aprova√ß√£o
- **Sincroniza√ß√£o bidirecional**: Melhorado m√©todo de rec√°lculo de horas dos timers
- **Compatibilidade de views**: JavaScript agora funciona tanto na view de gerenciamento quanto na de aprova√ß√£o

### üîß PROBLEMAS RESOLVIDOS
- JavaScript manage.js agora detecta automaticamente qual vari√°vel usar (manage_data ou approval_data)
- M√©todo recalculate_and_update_entry completamente reescrito para ser mais robusto
- Apenas timers finalizados s√£o considerados na sincroniza√ß√£o
- Logs detalhados para debugging da sincroniza√ß√£o

### üìã MELHORIAS T√âCNICAS
- Detec√ß√£o autom√°tica de vari√°veis JavaScript dependendo da view
- C√°lculo mais preciso da dura√ß√£o dos timers
- Limpeza e recria√ß√£o de entradas para evitar duplicatas
- Tratamento robusto de timestamps Unix vs strings de data

### üéØ FUNCIONALIDADES CORRIGIDAS
- Aprova√ß√£o e rejei√ß√£o funcionando na tela de visualiza√ß√£o
- Sincroniza√ß√£o do quadro de horas para o timesheet melhorada
- Logs detalhados para identificar problemas de sincroniza√ß√£o

## [1.1.0] - 2025-08-24

### üîÑ SINCRONIZA√á√ÉO BIDIRECIONAL MELHORADA
- **Hooks adicionais**: Adicionados hooks para capturar todas as altera√ß√µes no quadro de horas
- **Sincroniza√ß√£o completa**: Cria√ß√£o, edi√ß√£o e exclus√£o de timers agora refletem no timesheet
- **Tradu√ß√£o corrigida**: Adicionada tradu√ß√£o ausente para mensagens de erro

### üîß CORRE√á√ïES IMPLEMENTADAS
- **Hook task_timer_started**: Sincroniza quando timer √© iniciado
- **Hook task_timer_stopped**: Sincroniza quando timer √© finalizado
- **Hook after_update_task_timer**: Sincroniza edi√ß√µes manuais de timers
- **Tradu√ß√£o timesheet_cannot_edit_approved**: Mensagem de erro traduzida

### üéØ PROBLEMAS RESOLVIDOS
- Altera√ß√µes no quadro de horas do Perfex agora refletem automaticamente no timesheet
- Mensagens de erro n√£o traduzidas corrigidas
- Sincroniza√ß√£o bidirecional funcionando completamente

### üìã FUNCIONALIDADES ADICIONADAS
- Logs detalhados de sincroniza√ß√£o para debugging
- M√∫ltiplos hooks para capturar todas as opera√ß√µes de timer
- Tratamento robusto de diferentes formatos de dados dos hooks

## [1.0.9] - 2025-08-24

### üö® CORRE√á√ÉO CR√çTICA
- **Erro 500 no auto-save**: Corrigido erro que impedia salvamento autom√°tico
- **M√©todo can_edit_week**: Adicionado m√©todo ausente no modelo
- **Valida√ß√£o de tarefa**: Melhorada para n√£o bloquear campos sem tarefa selecionada

### üîß PROBLEMAS RESOLVIDOS
- Auto-save retornava erro 500 quando n√£o havia tarefa selecionada
- M√©todo `can_edit_week()` estava sendo chamado mas n√£o existia
- Valida√ß√£o muito restritiva impedia uso normal dos campos

### üìã FUNCIONALIDADES
- Auto-save agora funciona mesmo sem projeto/tarefa selecionados
- Formata√ß√£o de horas mantida (8 ‚Üí 8,00)
- Todas as funcionalidades anteriores preservadas

## [1.3.16] - 2025-01-26

### üöÄ SISTEMA DE SALVAMENTO H√çBRIDO IMPLEMENTADO

**PROBLEMA RESOLVIDO**: Auto-save com timeout muito baixo (300ms) causava perda de dados quando usu√°rio navegava rapidamente entre campos.

### ‚úÖ MELHORIAS CR√çTICAS
- **Debounce aumentado**: Timeout aumentado de 300ms para 1.5 segundos
- **Fila de salvamento**: Sistema sequencial previne race conditions
- **Salvamento for√ßado**: Antes de submiss√£o e navega√ß√£o entre p√°ginas
- **Backup autom√°tico**: Salvamento de seguran√ßa a cada 30 segundos
- **Indicadores visuais**: Status claro de "salvando", "salvo", "erro" com progresso

### üîß FUNCIONALIDADES T√âCNICAS
- **Queue System**: Processa altera√ß√µes sequencialmente sem duplicatas
- **Pending Changes Tracking**: Rastreia campos com altera√ß√µes n√£o salvas
- **Before Unload Protection**: Avisa usu√°rio sobre altera√ß√µes pendentes
- **Force Save**: Garantia de salvamento antes de a√ß√µes cr√≠ticas
- **Error Recovery**: Continua processamento mesmo se um campo falhar

### üéØ IMPACTO NA UX
- **Maior confiabilidade**: Dados nunca mais ser√£o perdidos por navega√ß√£o r√°pida
- **Feedback visual**: Usu√°rio sempre sabe o status de salvamento
- **Prote√ß√£o inteligente**: Sistema previne perda acidental de dados
- **Performance otimizada**: Salvamentos agrupados reduzem carga no servidor

### üõ°Ô∏è COMPATIBILIDADE
- Mant√©m todas as funcionalidades existentes
- Sincroniza√ß√£o bidirecional continua funcionando
- Sistema de aprova√ß√£o inalterado
- Interface sem mudan√ßas visuais significativas

## [1.0.8] - 2025-08-24

### üîß CORRE√á√ïES CR√çTICAS
- **Auto-save corrigido**: Fun√ß√£o de salvamento autom√°tico agora funciona corretamente
- **Formata√ß√£o de horas**: Campos sempre formatam valores, incluindo 0 (ex: "8" ‚Üí "8,00")
- **Valida√ß√£o melhorada**: Melhor tratamento de campos sem projeto/tarefa selecionados
- **Sincroniza√ß√£o bidirecional**: Corrigido problema na consulta de timers do Perfex CRM
- **Timestamp handling**: Melhor tratamento de timestamps Unix vs strings de data

### üéØ PROBLEMAS RESOLVIDOS
- Auto-save n√£o funcionava quando usu√°rio sa√≠a do campo de horas
- Campos de horas eram limpos ao inv√©s de formatados
- Sincroniza√ß√£o com quadro de horas do Perfex CRM falhava
- Problemas de integra√ß√£o bidirecional entre timesheet e tarefas

### üìã FUNCIONALIDADES MANTIDAS
- Interface 100% em portugu√™s brasileiro
- Sistema de aprova√ß√£o semanal
- Filtros para projetos/tarefas ativas
- Valida√ß√£o de tarefa obrigat√≥ria
- Navega√ß√£o semanal
- Bot√£o cancelar submiss√£o
- Integra√ß√£o com quadro de horas do Perfex CRM

## [1.0.7] - 2025-08-23

### ‚úÖ MELHORIAS IMPLEMENTADAS
- **Idioma Portuguese BR**: Pasta de idioma corrigida para `portuguese_br` conforme padr√£o
- **Envio Semanal Obrigat√≥rio**: Profissionais devem enviar horas para aprova√ß√£o toda semana
- **Auto-save Discreto**: Salvamento autom√°tico ao sair do campo com feedback visual sutil
- **Bot√£o Cancelar Submiss√£o**: Permite cancelar envio para fazer ajustes
- **Placeholder Sem Valor 0**: Campos vazios n√£o mostram 0, evitando problemas de digita√ß√£o
- **Semana Bloqueada**: Ap√≥s envio, semana fica bloqueada com apenas bot√£o cancelar dispon√≠vel
- **Motivo de Rejei√ß√£o**: Exibe motivo quando timesheet √© rejeitado pelo gerente

### üîß MELHORIAS T√âCNICAS
- Fun√ß√£o `cancel_submission` implementada no controller
- Auto-save discreto com indicadores visuais
- Sistema de bloqueio de semana baseado em status
- Interface melhorada para feedback de rejei√ß√£o
- Valida√ß√µes aprimoradas para envio semanal

### üåê TRADU√á√ÉO
- Interface 100% em portugu√™s brasileiro
- Mensagens de status amig√°veis
- Confirma√ß√µes e alertas traduzidos

---

## [1.0.6] - 2025-08-23

### üêõ CORRE√á√ÉO CR√çTICA
- **M√°scara de horas funcionando**: Corrigido problema onde valores eram apagados ao sair do campo
- Fun√ß√£o `formatHours` corrigida para usar ponto (.) em campos num√©ricos
- Valores agora s√£o preservados e formatados corretamente

### ‚úÖ FUNCIONALIDADES MANTIDAS
- Interface 100% em portugu√™s
- Sistema de aprova√ß√£o completo
- Filtros para projetos/tarefas ativas
- Valida√ß√£o de tarefa obrigat√≥ria

---

## [1.0.5] - 2025-08-23

### üêõ CORRE√á√ïES
- M√°scara de horas corrigida (n√£o apaga valores)
- Tradu√ß√£o portugu√™s funcionando (pasta `portuguese`)
- Pasta migrations restaurada conforme feedback
- Configura√ß√£o de vers√£o restaurada

### ‚ö†Ô∏è OBSERVA√á√ïES
- Vers√£o baseada em feedback do usu√°rio
- Estrutura de migra√ß√£o mantida para compatibilidade

---

## [1.0.4] - 2025-08-23 - ‚ö†Ô∏è DEPRECATED

### ‚ùå PROBLEMAS IDENTIFICADOS
- Configura√ß√£o de vers√£o removida causava conflitos
- Pasta migrations removida impedia instala√ß√£o
- Pasta portuguese_br n√£o reconhecida pelo sistema

### üö´ N√ÉO USAR ESTA VERS√ÉO

---

## [1.0.3] - 2025-08-23 - ‚ö†Ô∏è DEPRECATED

### ‚ùå PROBLEMA CR√çTICO
- Erro "unknown status (0)" na instala√ß√£o
- Arquivo install.php com erro de sintaxe
- Tela branca ao ativar m√≥dulo

### üö´ N√ÉO USAR ESTA VERS√ÉO

---

## [1.0.2] - 2025-08-23 - ‚ö†Ô∏è DEPRECATED

### ‚ùå PROBLEMA CR√çTICO
- Erro de instala√ß√£o que impede ativa√ß√£o
- Sistema de migra√ß√£o com conflitos

### üö´ N√ÉO USAR ESTA VERS√ÉO

---

## [1.0.1] - 2025-08-23

### ‚úÖ CORRE√á√ïES IMPLEMENTADAS
- Filtros para projetos e tarefas ativas
- Valida√ß√£o de tarefa obrigat√≥ria
- M√°scara num√©rica nos campos de horas
- Sistema de migra√ß√£o implementado

### üêõ PROBLEMAS CONHECIDOS
- Mensagem de erro falsa no submit
- M√°scara de horas com problemas

---

## [1.0.0] - 2025-08-23

### üéâ VERS√ÉO INICIAL
- Sistema b√°sico de timesheet
- Interface tipo planilha
- Navega√ß√£o semanal
- Sistema de aprova√ß√£o b√°sico
- Integra√ß√£o com projetos e tarefas do Perfex CRM

---

## üìã LEGENDA

- ‚úÖ **Funcionalidade implementada**
- üêõ **Corre√ß√£o de bug**
- üîß **Melhoria t√©cnica**
- üåê **Tradu√ß√£o/Idioma**
- ‚ö†Ô∏è **Vers√£o com problemas**
- üö´ **N√£o recomendada para uso**
- üéâ **Marco importante**